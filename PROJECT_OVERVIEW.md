# LSI Calculator - Краткий обзор проекта

## 🎯 Что это?

Flutter приложение для расчета LSI (индекс насыщения Ланжелье) - химического показателя воды в бассейнах.

---

## 🏛️ Архитектура в картинках

### Упрощенная схема MVVM:

```
┌────────────────────────────────────────────────────────┐
│                     VIEW                               │
│  (LSICalculatorScreen)                                 │
│  - Показывает форму                                    │
│  - Отображает результаты                               │
│  - НЕ содержит бизнес-логики                          │
└────────────────┬───────────────────────────────────────┘
                 │ Подписывается на State (ref.watch)
                 ▼
┌────────────────────────────────────────────────────────┐
│                   VIEWMODEL                            │
│  (LSIFormNotifier + LSIResultNotifier)                │
│  - Валидация данных                                    │
│  - Управление состоянием                               │
│  - Вызовы API                                          │
└────────────────┬───────────────────────────────────────┘
                 │ Использует
                 ▼
┌────────────────────────────────────────────────────────┐
│              SERVICES + MODELS                         │
│  Services: LSIApiService, TokenStorageService         │
│  Models: LSIParameters, LSIResult, ColorsResponse      │
└────────────────────────────────────────────────────────┘
```

---

## 📦 Составляющие проекта

### 1️⃣ **Models** (Модели данных)

Чистые классы данных без логики:

- `LSIParameters` - входные параметры (14 полей: 7 текущих + 7 желаемых)
- `LSIResult` - результат расчета (current, desired LSI)
- `ColorsResponse` - цвета для визуальной индикации

### 2️⃣ **Services** (Сервисы)

Бизнес-логика работы с API и хранилищем:

- `LSIApiService` - запросы к Orenda API
  - Автоматическая аутентификация через Dio Interceptors
  - Обновление токена при 401 ошибке
- `TokenStorageService` - безопасное хранение токенов в Secure Storage

### 3️⃣ **ViewModels** (Управление состоянием)

Два StateNotifier'а для разделения ответственности:

- `LSIFormNotifier` - управляет формой и валидацией
- `LSIResultNotifier` - управляет результатами расчета

### 4️⃣ **Views** (UI)

- `LSICalculatorScreen` - главный экран (ConsumerWidget)
- `InputField` - переиспользуемое поле ввода
- `LSIResultCard` - отображение результатов с цветами

---

## 🔄 Как работает поток данных?

```
1. Пользователь вводит данные → InputField
2. InputField → onChanged callback
3. Screen вызывает → viewModel.updateParameter()
4. ViewModel валидирует → обновляет state
5. State изменяется → UI автоматически обновляется (Riverpod)
6. Пользователь нажимает "Рассчитать"
7. ViewModel → вызывает LSIApiService.calculateLSI()
8. API возвращает результат → ViewModel сохраняет в state
9. UI показывает результат
```

---

## 🛡️ Ключевые особенности

### ✅ Безопасность

- Токены в Secure Storage (шифруются на уровне ОС)
- Автоматическое обновление токена при истечении

### ✅ Обработка ошибок

- Таймауты на все запросы
- Graceful degradation (работает даже если цвета не загрузились)
- Понятные сообщения об ошибках для пользователя

### ✅ Качество кода

- MVVM архитектура
- Type-safe (null-safety)
- Immutable state
- Переиспользуемые компоненты

---

## 🔧 Технологии

| Что                        | Зачем                           |
| -------------------------- | ------------------------------- |
| **Riverpod**               | State management (реактивность) |
| **Dio**                    | HTTP клиент с interceptors      |
| **flutter_secure_storage** | Безопасное хранение токенов     |
| **json_serializable**      | Автоматическая сериализация     |

---

## 📝 Структура файлов

```
lib/
├── constants/        # API константы (URL, токены)
├── models/          # Data классы (LSIParameters, LSIResult...)
├── services/        # API и storage сервисы
├── viewmodels/      # StateNotifier'ы (бизнес-логика)
├── views/           # Экраны (UI)
└── widgets/         # Переиспользуемые компоненты
```

---

## 💡 Главные принципы архитектуры

1. **Separation of Concerns** - каждый слой отвечает за свое
2. **Single Responsibility** - один класс = одна задача
3. **DRY** - переиспользуемые компоненты (InputField, Services)
4. **Immutability** - безопасные обновления через copyWith()
5. **Type Safety** - null-safety, строгая типизация

---

## 🎓 Для понимания проекта

**Начни с:**

1. `main.dart` - точка входа, инициализация
2. `lsi_calculator_screen.dart` - главный экран (View)
3. `lsi_calculator_viewmodel.dart` - логика (ViewModel)
4. `lsi_api_service.dart` - работа с API (Service)

**Потом изучи:**

- Models для понимания структуры данных
- Widgets для понимания UI компонентов
- Services для понимания API интеграции

---

## ❓ Быстрые ответы

**Почему два StateNotifier?**
→ Разные ответственности: форма vs результаты

**Почему Interceptors?**
→ Автоматическая аутентификация без дублирования кода

**Почему Secure Storage?**
→ Токены не должны храниться в открытом виде

**Почему MVVM?**
→ Разделение UI и логики, тестируемость, масштабируемость
